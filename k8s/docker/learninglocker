FROM node:8-alpine
# Learning Locker
RUN apk add --no-cache git curl alpine-sdk python
RUN npm install -g yarn pm2
RUN pm2 install pm2-logrotate && pm2 set pm2-logrotate:compress true
RUN git clone https://github.com/LearningLocker/learninglocker.git /src
RUN cd /src && yarn install
RUN cd /src && yarn build-all
ADD /k8s/scripts/start-general.sh /start-general.sh
ADD /env /src/.env
RUN chmod +x /start-general.sh

# Learning Locker xAPI stuff
#RUN git clone https://github.com/LearningLocker/xapi-service.git /src-xapi
#RUN cd /src-xapi && yarn install --ignore-engines && yarn build
#ADD /env-xapi /src-xapi/.env

# Install Nginx to front our stuff...
RUN apk add --no-cache supervisor
ADD /k8s/conf/supervisor /etc/supervisord-enabled/
ADD /k8s/conf/supervisor.conf /etc/supervisor.conf
CMD ["/start-general.sh"]